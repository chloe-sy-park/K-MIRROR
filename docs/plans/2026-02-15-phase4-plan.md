# Phase 4: 런칭 & 그로스 — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:subagent-driven-development to implement this plan task-by-task.

**Goal:** 성능 최적화 + GA4 이벤트 추적 7개 삽입 + 런칭 SEO/PWA 정리

**Architecture:** Recharts를 dynamic import로 분리하여 초기 번들을 줄이고, 기존 `src/lib/analytics.ts`의 `trackEvent()` 헬퍼를 7곳에 삽입하여 전환 퍼널을 추적한다. SEO 메타/JSON-LD/PWA manifest를 정리하여 런칭 준비를 완료한다.

**Tech Stack:** Vite (code splitting), Google Analytics 4 (gtag.js), VitePWA, JSON-LD

---

## Task 1: 성능 최적화 — Recharts dynamic import + 이미지 lazy loading

### 수정 파일

| 파일 | 변경 |
|------|------|
| `src/views/KGlowResultView.tsx` | MODIFY — RadarMetricsChart를 lazy import로 변경 |
| `src/views/AnalysisResultView.tsx` | MODIFY — 차트 컴포넌트 lazy import 확인 |
| `src/views/ChooseVibeView.tsx` | MODIFY — 셀럽 이미지에 `loading="lazy"` 추가 |
| `src/views/ShopView.tsx` | MODIFY — 제품 이미지에 `loading="lazy"` 추가 |
| `src/views/CelebGalleryView.tsx` | MODIFY — 셀럽 이미지에 `loading="lazy"` 추가 |
| `vite.config.ts` | MODIFY — Recharts를 별도 vendor 청크로 분리 |

### vite.config.ts 변경

manualChunks에 Recharts 추가:

```typescript
'vendor-recharts': ['recharts'],
```

이렇게 하면 normalizeMetrics 청크(487KB)에서 Recharts가 분리되어 별도 vendor로 로딩됩니다.

### KGlowResultView 변경

```typescript
// 기존:
import RadarMetricsChart from '@/components/charts/RadarMetricsChart';

// 변경:
import { lazy, Suspense } from 'react';
const RadarMetricsChart = lazy(() => import('@/components/charts/RadarMetricsChart'));

// JSX에서 Suspense 래핑:
<Suspense fallback={<div className="w-[200px] h-[200px]" />}>
  <RadarMetricsChart ... />
</Suspense>
```

### 이미지 lazy loading

셀럽/제품 이미지를 렌더링하는 `<img>` 태그에 `loading="lazy"` 속성 추가. 각 뷰에서 이미지 렌더링 패턴을 확인하고 적용.

### 검증

```bash
npm run typecheck && npm run build
```

빌드 후 `normalizeMetrics` 청크 크기 확인 — Recharts 분리 확인.

---

## Task 2: GA4 페이지뷰 자동 추적

### 수정 파일

| 파일 | 변경 |
|------|------|
| `src/lib/analytics.ts` | MODIFY — `trackPageView()` 함수 추가 |
| `src/App.tsx` | MODIFY — `usePageTracking()` 훅 추가 |

### analytics.ts 변경

```typescript
export function trackPageView(path: string, title?: string) {
  if (window.gtag) {
    window.gtag('event', 'page_view', {
      page_path: path,
      page_title: title,
    });
  }
}
```

### App.tsx 변경

기존 `useEffect`에서 `document.title` 업데이트하는 곳 (line ~93-100) 뒤에 페이지뷰 추적 추가:

```typescript
import { trackPageView } from '@/lib/analytics';

// 기존 useEffect 내부, document.title 설정 후:
useEffect(() => {
  const title = ROUTE_TITLES[location.pathname] ?? 'K-MIRROR';
  document.title = title;
  trackPageView(location.pathname, title);
}, [location.pathname]);
```

### 검증

```bash
npm run typecheck && npm run test:run
```

---

## Task 3: GA4 이벤트 추적 — 핵심 퍼널 (4개)

### 수정 파일

| 파일 | 변경 |
|------|------|
| `src/views/ChooseVibeView.tsx` | MODIFY — `handleContinue()`에 `celeb_selected` 이벤트 |
| `src/views/ScanView.tsx` | MODIFY — `handleAnalyze()`에 `selfie_uploaded` 이벤트 |
| `src/store/scanStore.ts` | MODIFY — `analyze()` 완료 시 `analysis_completed` 이벤트 |
| `src/components/kglow/SharePanel.tsx` | MODIFY — share/download/copy에 `card_shared` 이벤트 |

### ChooseVibeView.tsx

`handleContinue()` 함수에서 navigate 전에:

```typescript
import { trackEvent } from '@/lib/analytics';

const handleContinue = async () => {
  if (!selectedCeleb) return;
  await setCelebFromGallery(selectedCeleb);
  trackEvent('celeb_selected', { celeb_name: selectedCeleb.name });
  navigate('/scan');
};
```

### ScanView.tsx

`handleAnalyze()` 함수에서 analyze 호출 후:

```typescript
import { trackEvent } from '@/lib/analytics';

const handleAnalyze = () => {
  if (!biometricConsent) { setShowConsent(true); return; }
  trackEvent('selfie_uploaded', { has_celeb: !!celebImage });
  analyze(isSensitive, prefs);
};
```

### scanStore.ts

`analyze()` 함수에서 `phase: 'result'` 설정 후:

```typescript
import { trackEvent } from '@/lib/analytics';

// 분석 완료 후 (phase: 'result' 설정하는 곳):
set({ result: res, matchedProducts: products, phase: 'result' });
trackEvent('analysis_completed', {
  celeb_name: get().selectedCelebName ?? 'unknown',
  locale,
});
```

### SharePanel.tsx

`handleShare()`, `handleDownload()`, `handleCopyLink()`에 각각:

```typescript
import { trackEvent } from '@/lib/analytics';

// handleDownload 성공 시:
trackEvent('card_shared', { platform: 'download', celeb_name: celebName });

// handleShare 성공 시:
trackEvent('card_shared', { platform: 'share_api', celeb_name: celebName });

// handleCopyLink 성공 시:
trackEvent('card_shared', { platform: 'copy_link', celeb_name: celebName });
```

### 검증

```bash
npm run typecheck && npm run test:run
```

---

## Task 4: GA4 이벤트 추적 — 수익 퍼널 (3개)

### 수정 파일

| 파일 | 변경 |
|------|------|
| `src/views/KGlowResultView.tsx` | MODIFY — Unlock 클릭에 `premium_clicked` 이벤트 |
| `src/views/ArchiveView.tsx` | MODIFY — 결제 완료에 `payment_completed` 이벤트 |
| `src/views/ShopView.tsx` | MODIFY — Buy Now 클릭에 `affiliate_clicked` 이벤트 |
| `src/views/ProductDetailView.tsx` | MODIFY — Buy Now 클릭에 `affiliate_clicked` 이벤트 |

### KGlowResultView.tsx

```typescript
import { trackEvent } from '@/lib/analytics';

const handleUnlock = () => {
  trackEvent('premium_clicked', { analysis_id: analysisId });
  navigate('/premium-checkout');
};
```

### ArchiveView.tsx

리포트 생성 완료 (step === 'done') 시:

```typescript
import { trackEvent } from '@/lib/analytics';

// 리포트 생성 완료 시점:
trackEvent('payment_completed', { analysis_id: analysisId });
```

정확한 삽입 위치는 파일을 읽고 'done' 상태 설정 지점을 찾아야 합니다.

### ShopView.tsx + ProductDetailView.tsx

기존 affiliate `<a>` 태그에 onClick 추가:

```tsx
<a
  href={product.affiliate_url}
  target="_blank"
  rel="noopener noreferrer"
  onClick={() => trackEvent('affiliate_clicked', {
    product_name: product.name,
    source: 'shop',  // 또는 'product_detail'
  })}
  className="..."
>
```

### 검증

```bash
npm run typecheck && npm run test:run && npm run build
```

---

## Task 5: SEO/OG 메타 + JSON-LD + PWA 정리

### 수정 파일

| 파일 | 변경 |
|------|------|
| `index.html` | MODIFY — OG 메타 태그 강화, JSON-LD schema 추가 |
| `vite.config.ts` | MODIFY — PWA manifest 카테고리/설명 강화 |

### index.html OG 메타 강화

기존 OG 태그를 확인하고 누락된 것 보강:

```html
<meta property="og:type" content="website" />
<meta property="og:url" content="https://k-mirror.ai" />
<meta property="og:title" content="K-MIRROR AI — Global K-Beauty Stylist" />
<meta property="og:description" content="AI-powered K-Beauty analysis. Get your personalized K-GLOW Card with celeb-matched styling." />
<meta property="og:image" content="https://k-mirror.ai/og-image.png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="K-MIRROR AI — Global K-Beauty Stylist" />
<meta name="twitter:description" content="AI-powered K-Beauty analysis. Get your personalized K-GLOW Card." />
<meta name="twitter:image" content="https://k-mirror.ai/og-image.png" />
```

### JSON-LD Structured Data

`index.html` `<head>`에 추가:

```html
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "K-MIRROR AI",
  "description": "AI-powered K-Beauty analysis and personalized styling",
  "url": "https://k-mirror.ai",
  "applicationCategory": "LifestyleApplication",
  "operatingSystem": "Web",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD",
    "description": "Free K-GLOW Card analysis"
  }
}
</script>
```

### PWA manifest 강화

`vite.config.ts`의 manifest 섹션에 카테고리 추가:

```typescript
categories: ['beauty', 'lifestyle', 'health'],
lang: 'en',
dir: 'ltr',
```

### 검증

```bash
npm run build
```

빌드 후 `dist/index.html`과 `dist/manifest.webmanifest` 확인.

---

## Task 6: Tests + 전체 검증

### 생성/수정 파일

| 파일 | 내용 |
|------|------|
| `src/lib/analytics.test.ts` | CREATE — trackEvent, trackPageView 테스트 |

### analytics.test.ts 테스트 항목

- `trackEvent`가 `window.gtag` 호출
- `trackEvent`가 `window.gtag` 없을 때 에러 안 남
- `trackPageView`가 page_view 이벤트 전송
- `initAnalytics`가 PROD에서만 스크립트 삽입

### 전체 검증

```bash
npm run typecheck && npm run lint && npm run test:run && npm run build
```

---

## 의존성 순서

```
Task 1 (성능 최적화) ─── 독립
    │
    v
Task 2 (페이지뷰 추적) ─── Task 1 후 (번들 구조 안정화 후)
    │
    v
Task 3 (핵심 퍼널 이벤트 4개) ─── Task 2 후
Task 4 (수익 퍼널 이벤트 3개) ─── Task 2 후 (Task 3과 병렬 가능)
    │
    v
Task 5 (SEO/OG/PWA) ─── 독립
    │
    v
Task 6 (테스트 + 전체 검증) ─── 모두 완료 후
```

## 파일 목록

### 생성 (~1개)

```
src/lib/analytics.test.ts
```

### 수정 (~13개)

```
vite.config.ts
index.html
src/lib/analytics.ts
src/App.tsx
src/views/KGlowResultView.tsx
src/views/ChooseVibeView.tsx
src/views/ScanView.tsx
src/views/ShopView.tsx
src/views/ProductDetailView.tsx
src/views/CelebGalleryView.tsx
src/views/ArchiveView.tsx
src/store/scanStore.ts
src/components/kglow/SharePanel.tsx
```
