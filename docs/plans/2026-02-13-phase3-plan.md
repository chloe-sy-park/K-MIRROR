# Phase 3: 완성도 & 확장 — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:subagent-driven-development to implement this plan task-by-task.

**Goal:** Gemini 다국어 응답 + 데일리/오피스/글램 3버전 + Affiliate 구매 링크 UI

**Architecture:** Gemini Edge Function에 locale 파라미터와 styleVersions 출력을 한 번에 추가한다. 프론트엔드 타입/스키마를 확장하고, K-GLOW Card에 3버전 탭, PDF에 2페이지를 추가한다. Affiliate은 조건부 UI로 기존 `affiliate_url` DB 컬럼을 활용한다.

**Tech Stack:** Gemini API (Deno Edge Function), Recharts (미니 레이더), jsPDF + html2canvas (PDF), qrcode.react (QR), react-i18next

---

## Task 1: Foundation — DB migration + types + schemas + i18n

### 수정 파일

| 파일 | 변경 |
|------|------|
| `supabase/migrations/20260217000000_style_versions.sql` | CREATE — `analyses` 테이블에 `style_versions JSONB` 컬럼 추가 |
| `src/types/index.ts` | ADD — `StyleVersion` 인터페이스, `AnalysisResult.styleVersions` optional 필드, `Product.affiliate_url` 필드 |
| `src/schemas/analysisResult.ts` | ADD — `styleVersionSchema`, `analysisResultSchema`에 `styleVersions` optional 추가 |
| `src/i18n/en.json` | ADD — `styleVersions.*`, `affiliate.*` 키 |
| `src/i18n/ko.json` | ADD — 한국어 번역 |

### DB Migration

```sql
-- supabase/migrations/20260217000000_style_versions.sql
ALTER TABLE analyses ADD COLUMN IF NOT EXISTS style_versions JSONB;
```

### StyleVersion 타입 (types/index.ts)

```typescript
export interface MetricsShift {
  VW: number;
  CT: number;
  MF: number;
  LS: number;
  HI: number;
}

export interface StyleVersion {
  intensity: 'light' | 'medium' | 'full';
  base: string;
  eyes: string;
  lips: string;
  keyProducts: string[];
  metricsShift: MetricsShift;
}

export interface StyleVersions {
  daily: StyleVersion;
  office: StyleVersion;
  glam: StyleVersion;
}
```

`AnalysisResult`에 추가:
```typescript
styleVersions?: StyleVersions;
```

`Product`에 추가:
```typescript
affiliate_url?: string | null;
```

### Zod 스키마 (schemas/analysisResult.ts)

```typescript
const metricsShiftSchema = z.object({
  VW: z.number(),
  CT: z.number(),
  MF: z.number(),
  LS: z.number(),
  HI: z.number(),
});

const styleVersionSchema = z.object({
  intensity: z.enum(['light', 'medium', 'full']),
  base: z.string(),
  eyes: z.string(),
  lips: z.string(),
  keyProducts: z.array(z.string()),
  metricsShift: metricsShiftSchema,
});

// analysisResultSchema에 추가:
styleVersions: z.object({
  daily: styleVersionSchema,
  office: styleVersionSchema,
  glam: styleVersionSchema,
}).optional(),
```

### i18n 키

**en.json** (`styleVersions` 섹션):
```json
"styleVersions": {
  "title": "Style Versions",
  "daily": "Daily",
  "office": "Office",
  "glam": "Glam",
  "dailyDesc": "Light, everyday look",
  "officeDesc": "Professional polish",
  "glamDesc": "Full glam transformation",
  "base": "Base & Skin",
  "eyes": "Eyes & Brows",
  "lips": "Lips & Cheeks",
  "keyProducts": "Key Products",
  "metricsShift": "Expected Metrics Change",
  "notAvailable": "Style versions not available for this analysis"
},
"affiliate": {
  "buyNow": "Buy Now",
  "buyOn": "Buy on",
  "externalLink": "Opens in new tab",
  "noLink": "Coming soon"
}
```

**ko.json**: 동일 구조 한국어 번역.

### PDF i18n 키 추가

`pdf` 섹션에 추가:
```json
"styleVariationsTitle": "Style Variations",
"styleVariationsSubtitle": "Three looks tailored to your lifestyle",
"detailedSolutionsTitle": "Detailed Solutions by Scene",
"detailedSolutionsSubtitle": "Step-by-step guides for each look"
```

### 검증

```bash
npm run typecheck && npm run lint && npm run test:run
```

---

## Task 2: Gemini Edge Function — locale + styleVersions

### 수정 파일

| 파일 | 변경 |
|------|------|
| `supabase/functions/analyze-kbeauty/index.ts` | MODIFY — locale 입력 추가, 프롬프트에 언어 지시 추가, responseSchema에 styleVersions 추가 |

### 변경 상세

**1. 요청 body 파싱에 `locale` 추가 (line ~228)**:

```typescript
const {
  userImageBase64,
  celebImageBase64,
  userMimeType,
  celebMimeType,
  isSensitive,
  prefs,
  selectedCelebName,
  locale,  // 추가
} = body as {
  // ...기존 타입...
  locale?: string;
};

const outputLocale = locale === 'ko' ? 'Korean' : 'English';
```

**2. systemInstruction 프롬프트에 언어 + 3버전 지시 추가**:

프롬프트 끝에 (line ~305, `Output MUST be in valid JSON format only.` 앞):

```
═══ LANGUAGE DIRECTIVE ═══
Generate ALL text fields (descriptions, interpretations, solutions, coaching,
style explanations, adaptation logic) in ${outputLocale}.
Only metric labels (VW, CT, MF, LS, HI), brand names, and product names
stay in English regardless of locale.

═══ STYLE VERSIONS (3 LOOKS) ═══
Generate three makeup versions adapted to the user's face and the chosen celeb style:
- daily: Light everyday look. Minimal products, natural finish.
- office: Professional polish. Medium coverage, refined eye definition.
- glam: Full transformation toward the celeb reference. Maximum impact.

For each version provide:
- base: Detailed base/skin solution text
- eyes: Eye and brow solution text
- lips: Lip and cheek solution text
- keyProducts: 2-3 product type suggestions (e.g., "tinted moisturizer", "BB cream")
- metricsShift: Expected change in each of the 5 Metrics when this version is applied
  (positive = increase, negative = decrease, relative to user's current metrics)
```

**3. `buildResponseSchema()`에 styleVersions 추가**:

`required` 배열에 `'styleVersions'` 추가하고, properties에:

```typescript
styleVersions: {
  type: 'OBJECT',
  properties: {
    daily: buildStyleVersionSchema(),
    office: buildStyleVersionSchema(),
    glam: buildStyleVersionSchema(),
  },
  required: ['daily', 'office', 'glam'],
},
```

헬퍼:
```typescript
function buildStyleVersionSchema() {
  return {
    type: 'OBJECT',
    properties: {
      intensity: { type: 'STRING', description: 'light | medium | full' },
      base: { type: 'STRING' },
      eyes: { type: 'STRING' },
      lips: { type: 'STRING' },
      keyProducts: { type: 'ARRAY', items: { type: 'STRING' } },
      metricsShift: {
        type: 'OBJECT',
        properties: {
          VW: { type: 'NUMBER' },
          CT: { type: 'NUMBER' },
          MF: { type: 'NUMBER' },
          LS: { type: 'NUMBER' },
          HI: { type: 'NUMBER' },
        },
        required: ['VW', 'CT', 'MF', 'LS', 'HI'],
      },
    },
    required: ['intensity', 'base', 'eyes', 'lips', 'keyProducts', 'metricsShift'],
  };
}
```

### 검증

Supabase Edge Function은 로컬에서 직접 테스트 불가. 타입 호환성은 프론트엔드 typecheck로 간접 검증.

---

## Task 3: Frontend Data Flow — geminiService + scanStore + analysisService

### 수정 파일

| 파일 | 변경 |
|------|------|
| `src/services/geminiService.ts` | MODIFY — `analyzeSkin`, `analyzeKBeauty`에 `locale` 파라미터 추가, body에 포함 |
| `src/store/scanStore.ts` | MODIFY — `analyze` 함수에서 현재 i18n 언어를 가져와 분석 함수에 전달 |
| `src/services/analysisService.ts` | MODIFY — `saveAnalysis`에 `style_versions` 컬럼 write, `fetchAnalysis`에 read 추가 |

### geminiService.ts 변경

`analyzeSkin`과 `analyzeKBeauty` 둘 다:

1. 파라미터에 `locale?: string` 추가 (signal 뒤)
2. `body: JSON.stringify({ ...기존, locale })` 에 locale 포함

```typescript
export const analyzeSkin = async (
  userImageBase64: string,
  celebImageBase64: string,
  isSensitive: boolean,
  prefs: UserPreferences,
  selectedCelebName?: string,
  signal?: AbortSignal,
  userMimeType = 'image/jpeg',
  celebMimeType = 'image/jpeg',
  locale?: string,  // 추가
): Promise<AnalysisResult> => {
  // ...
  body: JSON.stringify({
    userImageBase64, celebImageBase64, userMimeType, celebMimeType,
    isSensitive, prefs, selectedCelebName,
    locale,  // 추가
  }),
```

`analyzeKBeauty`도 동일하게 수정.

### scanStore.ts 변경

`analyze` 함수 시작 부분에서 i18n 언어 가져오기:

```typescript
import i18n from '@/i18n';  // 또는 i18next 직접 import
// ...
analyze: async (isSensitive, prefs) => {
  const locale = i18n.language?.startsWith('ko') ? 'ko' : 'en';
  // ...
  res = await analyzeSkin(..., locale);
  // ...fallback...
  res = await analyzeKBeauty(..., locale);
```

**주의**: `i18n` 인스턴스의 import 경로는 `src/i18n/index.ts` 또는 `src/i18n.ts` 확인 필요.

### analysisService.ts 변경

`saveAnalysis` insert 객체에:
```typescript
style_versions: result.styleVersions ?? null,
```

`fetchAnalysis` select에 `style_versions` 추가, 반환 객체에:
```typescript
styleVersions: data.style_versions ?? undefined,
```

### 검증

```bash
npm run typecheck && npm run test:run
```

---

## Task 4: K-GLOW Card 3-Version Tabs

### 수정 파일

| 파일 | 변경 |
|------|------|
| `src/views/KGlowResultView.tsx` | MODIFY — styleVersions 탭 UI 추가 |
| `src/components/charts/RadarMetricsChart.tsx` | 그대로 사용 (이미 celebMetrics optional) |

### KGlowResultView 변경

K-GLOW Card와 CTA 버튼 사이에 3버전 탭 섹션 추가:

```tsx
const styleVersions = result?.styleVersions ?? null;
const [activeVersion, setActiveVersion] = useState<'daily' | 'office' | 'glam'>('glam');

// styleVersions가 있을 때만 탭 표시
{styleVersions && (
  <m.div variants={itemVariants} className="w-full max-w-md mt-8">
    {/* Pill tabs */}
    <div className="flex gap-2 mb-6">
      {(['daily', 'office', 'glam'] as const).map((v) => (
        <button
          key={v}
          onClick={() => setActiveVersion(v)}
          className={`flex-1 py-2 rounded-xl text-xs font-black uppercase tracking-wider transition-all ${
            activeVersion === v
              ? 'bg-gradient-to-r from-[#FF4D8D] to-[#FF6B9D] text-white'
              : 'bg-white/10 text-white/50 hover:text-white/80'
          }`}
        >
          {t(`styleVersions.${v}`)}
        </button>
      ))}
    </div>

    {/* Active version content */}
    <div className="bg-[#1A1A2E] rounded-3xl border border-white/10 p-6">
      <p className="text-[#FFD700] font-mono text-xs uppercase tracking-widest mb-4">
        {t(`styleVersions.${activeVersion}Desc`)}
      </p>

      {/* Base / Eyes / Lips */}
      {(['base', 'eyes', 'lips'] as const).map((area) => (
        <div key={area} className="mb-4">
          <h4 className="text-white/40 font-mono text-xs uppercase tracking-wider mb-1">
            {t(`styleVersions.${area}`)}
          </h4>
          <p className="text-white/80 text-sm">
            {styleVersions[activeVersion][area]}
          </p>
        </div>
      ))}

      {/* Key Products */}
      <div className="flex flex-wrap gap-2 mt-4">
        {styleVersions[activeVersion].keyProducts.map((p, i) => (
          <span key={i} className="px-3 py-1 bg-[#00D4FF]/10 text-[#00D4FF] text-xs font-mono rounded-full">
            {p}
          </span>
        ))}
      </div>

      {/* Mini radar showing metrics shift */}
      {fiveMetrics && (
        <div className="mt-6 flex justify-center">
          <RadarMetricsChart
            userMetrics={normalizeMetrics(fiveMetrics)}
            celebMetrics={applyMetricsShift(
              normalizeMetrics(fiveMetrics),
              styleVersions[activeVersion].metricsShift
            )}
            size={200}
          />
        </div>
      )}
    </div>
  </m.div>
)}
```

### applyMetricsShift 헬퍼

`src/components/charts/normalizeMetrics.ts`에 추가:

```typescript
export function applyMetricsShift(
  base: NormalizedMetrics,
  shift: { VW: number; CT: number; MF: number; LS: number; HI: number },
): NormalizedMetrics {
  return {
    VW: clamp(base.VW + shift.VW),
    CT: clamp(base.CT + shift.CT),
    MF: clamp(base.MF + shift.MF),
    LS: clamp(base.LS + shift.LS),
    HI: clamp(base.HI + shift.HI),
  };
}
```

`clamp` 함수는 이미 파일 내에 있음 (private) → export하거나 `applyMetricsShift` 안에서 인라인.

### 검증

```bash
npm run typecheck && npm run build
```

---

## Task 5: PDF Style Versions — 2 new pages + pdfService update

### 생성 파일

| 파일 | 내용 |
|------|------|
| `src/components/pdf/PdfStyleVariations.tsx` | 페이지 7 — 3칸 레이아웃으로 Daily/Office/Glam 개요 + 미니 레이더 3개 |
| `src/components/pdf/PdfDetailedSolutions.tsx` | 페이지 8 — Daily + Office 상세 솔루션 (Glam은 기존 Solution 참조) |

### 수정 파일

| 파일 | 변경 |
|------|------|
| `src/services/pdfService.tsx` | MODIFY — TOTAL_PAGES=12, 새 페이지 렌더링, 기존 페이지 번호 조정 |

### PdfStyleVariations.tsx

**Props:**
```typescript
interface PdfStyleVariationsProps {
  styleVersions: StyleVersions;
  userMetrics: NormalizedMetrics;
}
```

**레이아웃:**
- 3칸 가로 레이아웃 (각 ~240px 너비)
- 각 칸: 버전명(Daily/Office/Glam), intensity 라벨, 미니 레이더 차트 (120px), keyProducts 칩들
- 미니 레이더: 현재 metrics(핑크) + shifted metrics(시안/금/레드) 오버레이
- 인라인 스타일 (html2canvas용)

### PdfDetailedSolutions.tsx

**Props:**
```typescript
interface PdfDetailedSolutionsProps {
  styleVersions: StyleVersions;
}
```

**레이아웃:**
- Daily 섹션: Base/Eyes/Lips 솔루션 텍스트
- Office 섹션: Base/Eyes/Lips 솔루션 텍스트
- Glam 참조 노트: "See pages 9-10 for full Glam solution"
- PdfPageShell 사용하지 않음 (pdfService에서 감싸줌)

### pdfService.tsx 변경

1. `TOTAL_PAGES = 12`
2. 페이지 순서:
   - 1: Cover
   - 2: Skeletal
   - 3: Metrics Overview
   - 4-5: Metrics Deep
   - 6: Translation
   - **7: Style Variations (NEW)**
   - **8: Detailed Solutions (NEW)**
   - 9-10: Solution (기존 7-8)
   - 11: Products (기존 9)
   - 12: Final Reveal (기존 10)
3. `styleVersions`가 없으면 빈 fallback 데이터로 페이지 생성 또는 해당 2페이지를 빈 placeholder로 대체

### 검증

```bash
npm run typecheck && npm run build
```

---

## Task 6: Affiliate UI — Shop + ProductDetail + PDF + AnalysisResult

### 수정 파일

| 파일 | 변경 |
|------|------|
| `src/services/productService.ts` | MODIFY — `fetchProducts`가 `affiliate_url`을 포함하도록 Product 매핑 수정 |
| `src/views/ShopView.tsx` | MODIFY — 제품 카드에 조건부 "Buy Now" 버튼 추가 |
| `src/views/ProductDetailView.tsx` | MODIFY — 조건부 "Buy Now" 버튼 추가 |
| `src/components/pdf/PdfProducts.tsx` | MODIFY — affiliate_url이 있으면 QR 코드 추가 |
| `src/views/AnalysisResultView.tsx` | MODIFY — 추천 제품에 조건부 "Buy" 링크 추가 |

### productService.ts 변경

`fetchProducts` 함수의 select 쿼리와 Product 매핑에 `affiliate_url` 포함:

```typescript
// select에 affiliate_url 추가
.select('id, name_en, brand, ..., affiliate_url')

// 매핑에 추가
affiliate_url: row.affiliate_url ?? null,
```

### ShopView.tsx — 조건부 Buy Now

각 제품 카드에서 "Add to Cart" 버튼 옆에:

```tsx
{product.affiliate_url && (
  <a
    href={product.affiliate_url}
    target="_blank"
    rel="noopener noreferrer"
    className="..."
  >
    <ExternalLink size={12} />
    {t('affiliate.buyNow')}
  </a>
)}
```

### ProductDetailView.tsx — 조건부 Buy Now

기존 "Add to Cart" 버튼 위에:

```tsx
{product.affiliate_url && (
  <a
    href={product.affiliate_url}
    target="_blank"
    rel="noopener noreferrer"
    className="w-full flex items-center justify-center gap-3 py-4 px-6 bg-gradient-to-r from-[#FF4D8D] to-[#FF6B9D] text-white rounded-2xl font-black text-sm uppercase tracking-[0.2em]"
  >
    {t('affiliate.buyNow')}
    <ExternalLink size={16} />
  </a>
)}
```

### PdfProducts.tsx — 조건부 QR 코드

제품 카드에 `affiliate_url` prop 추가. 있으면 카드 하단에 QR 코드 (60x60px):

```tsx
import { QRCodeSVG } from 'qrcode.react';

// 제품 카드 내:
{product.affiliateUrl && (
  <div style={{ marginTop: 8 }}>
    <QRCodeSVG value={product.affiliateUrl} size={60} bgColor="transparent" fgColor="#ffffff" />
  </div>
)}
```

**주의**: pdfService.tsx에서 PdfProducts로 `affiliate_url`을 전달하도록 matchedProducts 매핑 수정 필요.

### AnalysisResultView.tsx — 조건부 Buy 링크

추천 제품 섹션(matchedProducts 표시 부분)에서 각 제품에:

```tsx
{product.affiliate_url && (
  <a href={product.affiliate_url} target="_blank" rel="noopener noreferrer"
     className="text-[#FF2D9B] text-xs font-bold uppercase tracking-wider">
    {t('affiliate.buyNow')} →
  </a>
)}
```

### 검증

```bash
npm run typecheck && npm run lint && npm run build
```

---

## Task 7: Tests + Verification

### 생성/수정 파일

| 파일 | 내용 |
|------|------|
| `src/components/charts/normalizeMetrics.test.ts` | CREATE — `applyMetricsShift` 테스트 (clamping, positive/negative shift) |
| `src/views/KGlowResultView.test.tsx` | CREATE or MODIFY — 3버전 탭 표시/숨김, 탭 전환 |
| `src/services/analysisService.test.ts` | MODIFY — styleVersions 저장/조회 테스트 추가 |

### 테스트 항목

**normalizeMetrics.test.ts:**
- `applyMetricsShift` positive shift가 정상 적용
- `applyMetricsShift` negative shift가 정상 적용
- 0 미만이나 100 초과 시 clamp

**KGlowResultView.test.tsx:**
- `styleVersions`가 없으면 탭 영역이 숨겨짐
- `styleVersions`가 있으면 3개 탭 버튼이 보임
- 탭 클릭 시 해당 버전의 솔루션 텍스트가 보임

**analysisService.test.ts:**
- `saveAnalysis`가 `style_versions`를 insert 페이로드에 포함
- `fetchAnalysis`가 `styleVersions`를 반환

### 전체 검증

```bash
npm run typecheck && npm run lint && npm run test:run && npm run build
```

---

## 의존성 순서

```
Task 1 (foundation)  ─┐
Task 2 (gemini)      ─┼─ 병렬 가능
                      │
                      v
Task 3 (data flow)    ─ Task 1,2 완료 후
                      │
        ┌─────────────┼─────────────┐
        v             v             v
Task 4 (K-GLOW tabs) Task 5 (PDF)  Task 6 (affiliate)
        │             │             │
        └─────────────┼─────────────┘
                      v
               Task 7 (tests)
```

## 파일 목록

### 생성 (~4개)

```
supabase/migrations/20260217000000_style_versions.sql
src/components/pdf/PdfStyleVariations.tsx
src/components/pdf/PdfDetailedSolutions.tsx
src/components/charts/normalizeMetrics.test.ts
```

### 수정 (~15개)

```
src/types/index.ts
src/schemas/analysisResult.ts
src/i18n/en.json
src/i18n/ko.json
src/services/geminiService.ts
src/store/scanStore.ts
src/services/analysisService.ts
src/views/KGlowResultView.tsx
src/components/charts/normalizeMetrics.ts
src/services/pdfService.tsx
src/services/productService.ts
src/views/ShopView.tsx
src/views/ProductDetailView.tsx
src/components/pdf/PdfProducts.tsx
src/views/AnalysisResultView.tsx
supabase/functions/analyze-kbeauty/index.ts
```
