# Phase 5: 바이럴 강화 — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:subagent-driven-development to implement this plan task-by-task.

**Goal:** 공유 K-GLOW 갤러리 + 딥링크 랜딩 (동적 OG) + 좋아요/댓글 + 공유 통계로 바이럴 루프 완성

**Architecture:** SharePanel에서 "공개 공유" 시 카드 이미지를 Supabase Storage에 업로드하고 `shared_cards` 레코드를 생성한다. 딥링크 `/s/:slug`는 Supabase Edge Function으로 OG 태그를 서빙하고 SPA로 리다이렉트한다. 갤러리는 공개 shared_cards를 그리드로 표시하며, 좋아요/댓글은 인증된 사용자만 가능하다.

**Tech Stack:** Supabase (DB + Storage + Edge Functions + RLS), React Router (lazy routes), html2canvas (OG 이미지), nanoid (slug), Intersection Observer (infinite scroll)

---

## Task 1: Foundation — DB 마이그레이션 + 공유 서비스

### 수정/생성 파일

| 파일 | 변경 |
|------|------|
| `supabase/migrations/20260218000000_shared_gallery.sql` | CREATE — shared_cards, card_likes, card_comments 테이블 + RLS |
| `src/services/galleryService.ts` | CREATE — CRUD: publishCard, fetchSharedCard, fetchGalleryCards, toggleLike, addComment, fetchComments, fetchMyShares |

### DB 마이그레이션

```sql
-- shared_cards: 공개된 K-GLOW 카드
CREATE TABLE IF NOT EXISTS public.shared_cards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  analysis_id UUID REFERENCES public.analyses(id),
  user_id UUID REFERENCES auth.users(id),
  slug TEXT UNIQUE NOT NULL,
  celeb_name TEXT NOT NULL,
  match_rate INTEGER NOT NULL,
  card_image_url TEXT NOT NULL,
  og_image_url TEXT,
  is_public BOOLEAN DEFAULT true,
  likes_count INTEGER DEFAULT 0,
  views_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_shared_cards_slug ON public.shared_cards(slug);
CREATE INDEX idx_shared_cards_user ON public.shared_cards(user_id);
CREATE INDEX idx_shared_cards_public ON public.shared_cards(is_public, created_at DESC);

ALTER TABLE public.shared_cards ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Anyone can view public cards" ON public.shared_cards
  FOR SELECT USING (is_public = true);
CREATE POLICY "Users can manage own cards" ON public.shared_cards
  FOR ALL USING (auth.uid() = user_id);

-- card_likes: 좋아요
CREATE TABLE IF NOT EXISTS public.card_likes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  shared_card_id UUID REFERENCES public.shared_cards(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(shared_card_id, user_id)
);

ALTER TABLE public.card_likes ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Anyone can view likes" ON public.card_likes FOR SELECT USING (true);
CREATE POLICY "Auth users can manage own likes" ON public.card_likes
  FOR ALL USING (auth.uid() = user_id);

-- card_comments: 댓글
CREATE TABLE IF NOT EXISTS public.card_comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  shared_card_id UUID REFERENCES public.shared_cards(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id),
  content TEXT NOT NULL CHECK (char_length(content) <= 500),
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_comments_card ON public.card_comments(shared_card_id, created_at DESC);

ALTER TABLE public.card_comments ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Anyone can view comments" ON public.card_comments FOR SELECT USING (true);
CREATE POLICY "Auth users can create comments" ON public.card_comments
  FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can delete own comments" ON public.card_comments
  FOR DELETE USING (auth.uid() = user_id);

-- likes_count 업데이트 트리거
CREATE OR REPLACE FUNCTION update_likes_count() RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE public.shared_cards SET likes_count = likes_count + 1 WHERE id = NEW.shared_card_id;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE public.shared_cards SET likes_count = likes_count - 1 WHERE id = OLD.shared_card_id;
  END IF;
  RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_likes_count
  AFTER INSERT OR DELETE ON public.card_likes
  FOR EACH ROW EXECUTE FUNCTION update_likes_count();
```

### galleryService.ts 핵심 함수들

```typescript
import { supabase, isSupabaseConfigured } from '@/lib/supabase';

// nanoid 대신 crypto.randomUUID().slice(0,8) 사용하여 추가 의존성 없이 slug 생성
function generateSlug(): string {
  return crypto.randomUUID().replace(/-/g, '').slice(0, 8);
}

export interface SharedCard {
  id: string;
  slug: string;
  celeb_name: string;
  match_rate: number;
  card_image_url: string;
  og_image_url: string | null;
  is_public: boolean;
  likes_count: number;
  views_count: number;
  created_at: string;
  user_id: string | null;
  analysis_id: string | null;
}

export interface CardComment {
  id: string;
  content: string;
  created_at: string;
  user_id: string;
}

export async function publishCard(params: {
  analysisId: string | null;
  celebName: string;
  matchRate: number;
  cardImageUrl: string;
  ogImageUrl?: string;
}): Promise<{ slug: string } | null> {
  if (!isSupabaseConfigured) return null;
  const { data: userData } = await supabase.auth.getUser();
  const slug = generateSlug();

  const { error } = await supabase.from('shared_cards').insert({
    analysis_id: params.analysisId,
    user_id: userData.user?.id ?? null,
    slug,
    celeb_name: params.celebName,
    match_rate: params.matchRate,
    card_image_url: params.cardImageUrl,
    og_image_url: params.ogImageUrl ?? null,
  });

  if (error) {
    if (import.meta.env.DEV) console.error('Failed to publish card:', error.message);
    return null;
  }
  return { slug };
}

export async function fetchSharedCard(slug: string): Promise<SharedCard | null> {
  if (!isSupabaseConfigured) return null;
  const { data, error } = await supabase
    .from('shared_cards')
    .select('*')
    .eq('slug', slug)
    .eq('is_public', true)
    .single();
  if (error) return null;
  return data;
}

export async function incrementViews(cardId: string): Promise<void> {
  if (!isSupabaseConfigured) return;
  await supabase.rpc('increment_views', { card_id: cardId });
}

export async function fetchGalleryCards(params: {
  limit?: number;
  offset?: number;
  celebFilter?: string;
  sort?: 'recent' | 'popular';
}): Promise<SharedCard[]> {
  if (!isSupabaseConfigured) return [];
  const { limit = 20, offset = 0, celebFilter, sort = 'recent' } = params;

  let query = supabase
    .from('shared_cards')
    .select('*')
    .eq('is_public', true);

  if (celebFilter) query = query.eq('celeb_name', celebFilter);
  if (sort === 'popular') query = query.order('likes_count', { ascending: false });
  else query = query.order('created_at', { ascending: false });

  const { data, error } = await query.range(offset, offset + limit - 1);
  if (error) return [];
  return data ?? [];
}

export async function toggleLike(cardId: string): Promise<boolean> {
  if (!isSupabaseConfigured) return false;
  const { data: userData } = await supabase.auth.getUser();
  if (!userData.user) return false;

  const { data: existing } = await supabase
    .from('card_likes')
    .select('id')
    .eq('shared_card_id', cardId)
    .eq('user_id', userData.user.id)
    .single();

  if (existing) {
    await supabase.from('card_likes').delete().eq('id', existing.id);
    return false; // unliked
  } else {
    await supabase.from('card_likes').insert({
      shared_card_id: cardId,
      user_id: userData.user.id,
    });
    return true; // liked
  }
}

export async function hasUserLiked(cardId: string): Promise<boolean> {
  if (!isSupabaseConfigured) return false;
  const { data: userData } = await supabase.auth.getUser();
  if (!userData.user) return false;

  const { data } = await supabase
    .from('card_likes')
    .select('id')
    .eq('shared_card_id', cardId)
    .eq('user_id', userData.user.id)
    .single();
  return !!data;
}

export async function addComment(cardId: string, content: string): Promise<CardComment | null> {
  if (!isSupabaseConfigured) return null;
  const { data: userData } = await supabase.auth.getUser();
  if (!userData.user) return null;

  const { data, error } = await supabase
    .from('card_comments')
    .insert({
      shared_card_id: cardId,
      user_id: userData.user.id,
      content: content.trim().slice(0, 500),
    })
    .select('id, content, created_at, user_id')
    .single();

  if (error) return null;
  return data;
}

export async function fetchComments(cardId: string, limit = 20, offset = 0): Promise<CardComment[]> {
  if (!isSupabaseConfigured) return [];
  const { data, error } = await supabase
    .from('card_comments')
    .select('id, content, created_at, user_id')
    .eq('shared_card_id', cardId)
    .order('created_at', { ascending: false })
    .range(offset, offset + limit - 1);
  if (error) return [];
  return data ?? [];
}

export async function fetchMyShares(): Promise<SharedCard[]> {
  if (!isSupabaseConfigured) return [];
  const { data: userData } = await supabase.auth.getUser();
  if (!userData.user) return [];

  const { data, error } = await supabase
    .from('shared_cards')
    .select('*')
    .eq('user_id', userData.user.id)
    .order('created_at', { ascending: false });
  if (error) return [];
  return data ?? [];
}
```

마이그레이션에 `increment_views` RPC도 추가:

```sql
-- views_count 증가 RPC (중복 방지 없이 단순 증가)
CREATE OR REPLACE FUNCTION increment_views(card_id UUID) RETURNS VOID AS $$
BEGIN
  UPDATE public.shared_cards SET views_count = views_count + 1 WHERE id = card_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 검증

```bash
npm run typecheck
```

---

## Task 2: 카드 이미지 업로드 + SharePanel "공개 공유" 버튼

### 수정 파일

| 파일 | 변경 |
|------|------|
| `src/components/kglow/SharePanel.tsx` | MODIFY — "Publish to Gallery" 버튼 추가 |
| `src/services/storageService.ts` | MODIFY — `shared-cards` 버킷 지원 추가 |

### storageService.ts 변경

기존 `uploadImage` 함수의 bucket 타입에 `'shared-cards'`를 추가:

```typescript
export async function uploadImage(
  base64: string,
  bucket: 'user-images' | 'celeb-images' | 'shared-cards' = 'user-images'
): Promise<string> {
```

### SharePanel.tsx 변경

기존 SharePanel에 "Publish to Gallery" 버튼 추가. 기존 download/share/copy 버튼 아래에 배치.

```typescript
import { publishCard } from '@/services/galleryService';
import { uploadImage } from '@/services/storageService';
import { trackEvent } from '@/lib/analytics';

// 기존 props에 matchRate 추가
interface SharePanelProps {
  cardRef: React.RefObject<HTMLDivElement | null>;
  analysisId: string | null;
  celebName: string;
  matchRate?: number; // 추가
}

// 컴포넌트 내부에 추가:
const [isPublishing, setIsPublishing] = useState(false);
const [publishedSlug, setPublishedSlug] = useState<string | null>(null);

const handlePublish = useCallback(async () => {
  if (!cardRef.current || isPublishing) return;
  setIsPublishing(true);
  try {
    const { canvas } = await captureCard();
    const dataUrl = canvas.toDataURL('image/png');
    const imageUrl = await uploadImage(dataUrl, 'shared-cards');

    const result = await publishCard({
      analysisId,
      celebName,
      matchRate: matchRate ?? 0,
      cardImageUrl: imageUrl,
    });

    if (result) {
      setPublishedSlug(result.slug);
      trackEvent('card_published', { celeb_name: celebName, slug: result.slug });
    }
  } finally {
    setIsPublishing(false);
  }
}, [cardRef, isPublishing, captureCard, analysisId, celebName, matchRate]);
```

JSX에 버튼 추가 (기존 copy link 버튼 아래):

```tsx
{/* Publish to Gallery */}
{publishedSlug ? (
  <div className="flex items-center gap-2 text-green-400 text-xs">
    <Globe size={14} />
    <span>{t('share.published')}</span>
    <button
      onClick={() => {
        navigator.clipboard.writeText(`https://k-mirror.ai/s/${publishedSlug}`);
      }}
      className="underline"
    >
      {t('share.copyShareLink')}
    </button>
  </div>
) : (
  <button
    onClick={handlePublish}
    disabled={isPublishing}
    className="flex items-center gap-2 text-white/60 hover:text-white text-xs transition-colors"
  >
    <Globe size={14} />
    {isPublishing ? t('share.publishing') : t('share.publishToGallery')}
  </button>
)}
```

### KGlowResultView에서 matchRate prop 전달

`src/views/KGlowResultView.tsx`에서 SharePanel에 `matchRate` 추가:

```tsx
<SharePanel
  cardRef={cardRef}
  analysisId={analysisId}
  celebName={celebName}
  matchRate={matchRate}
/>
```

### 검증

```bash
npm run typecheck && npm run test:run
```

---

## Task 3: 딥링크 랜딩 페이지 + OG Edge Function

### 생성/수정 파일

| 파일 | 변경 |
|------|------|
| `src/views/SharedCardView.tsx` | CREATE — `/s/:slug` 딥링크 랜딩 페이지 |
| `supabase/functions/serve-og-card/index.ts` | CREATE — 동적 OG 메타 서빙 Edge Function |
| `src/App.tsx` | MODIFY — `/s/:slug` 라우트 추가 |

### SharedCardView.tsx

```typescript
import { useState, useEffect, useCallback } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import * as m from 'framer-motion/m';
import { Heart, MessageCircle, Eye, ArrowRight } from 'lucide-react';
import { containerVariants, itemVariants } from '@/constants/animations';
import { trackEvent } from '@/lib/analytics';
import { useAuthStore } from '@/store/authStore';
import {
  fetchSharedCard, incrementViews, toggleLike, hasUserLiked,
  addComment, fetchComments,
  type SharedCard, type CardComment,
} from '@/services/galleryService';

const SharedCardView = () => {
  const { slug } = useParams<{ slug: string }>();
  const { t } = useTranslation();
  const navigate = useNavigate();
  const user = useAuthStore((s) => s.user);
  const openAuthModal = useAuthStore((s) => s.openAuthModal);

  const [card, setCard] = useState<SharedCard | null>(null);
  const [loading, setLoading] = useState(true);
  const [liked, setLiked] = useState(false);
  const [likesCount, setLikesCount] = useState(0);
  const [comments, setComments] = useState<CardComment[]>([]);
  const [newComment, setNewComment] = useState('');
  const [submitting, setSubmitting] = useState(false);

  useEffect(() => {
    if (!slug) return;
    trackEvent('deeplink_visited', { slug });

    (async () => {
      const data = await fetchSharedCard(slug);
      setCard(data);
      setLoading(false);
      if (data) {
        setLikesCount(data.likes_count);
        incrementViews(data.id);
        const userLiked = await hasUserLiked(data.id);
        setLiked(userLiked);
        const cmts = await fetchComments(data.id, 5);
        setComments(cmts);
      }
    })();
  }, [slug]);

  const handleLike = useCallback(async () => {
    if (!user) { openAuthModal(); return; }
    if (!card) return;
    const nowLiked = await toggleLike(card.id);
    setLiked(nowLiked);
    setLikesCount((prev) => prev + (nowLiked ? 1 : -1));
  }, [user, card, openAuthModal]);

  const handleComment = useCallback(async () => {
    if (!user) { openAuthModal(); return; }
    if (!card || !newComment.trim() || submitting) return;
    setSubmitting(true);
    const comment = await addComment(card.id, newComment);
    if (comment) {
      setComments((prev) => [comment, ...prev]);
      setNewComment('');
    }
    setSubmitting(false);
  }, [user, card, newComment, submitting, openAuthModal]);

  const handleTryIt = () => {
    trackEvent('gallery_cta_clicked', { slug, source: 'deeplink' });
    navigate('/choose-vibe');
  };

  if (loading) return /* loading spinner */;
  if (!card) return /* 404 not found */;

  return (
    <m.div initial="hidden" animate="visible" variants={containerVariants}
      className="min-h-screen bg-[#0A0A1A] flex flex-col items-center px-4 py-12">
      {/* Card Image */}
      <m.div variants={itemVariants} className="w-full max-w-md">
        <img src={card.card_image_url} alt={`K-GLOW Card - ${card.celeb_name}`}
          className="w-full rounded-3xl" loading="eager" />
      </m.div>

      {/* Info */}
      <m.div variants={itemVariants} className="w-full max-w-md mt-6 text-center">
        <p className="text-white/60 text-sm">{card.celeb_name} · {card.match_rate}% Match</p>
        <div className="flex justify-center gap-6 mt-4 text-white/40 text-xs">
          <span className="flex items-center gap-1"><Eye size={14} /> {card.views_count}</span>
          <button onClick={handleLike}
            className={`flex items-center gap-1 transition-colors ${liked ? 'text-[#FF4D8D]' : 'hover:text-white/80'}`}>
            <Heart size={14} fill={liked ? 'currentColor' : 'none'} /> {likesCount}
          </button>
          <span className="flex items-center gap-1"><MessageCircle size={14} /> {comments.length}</span>
        </div>
      </m.div>

      {/* CTA */}
      <m.button variants={itemVariants} onClick={handleTryIt}
        className="mt-8 flex items-center gap-3 py-4 px-8 bg-gradient-to-r from-[#FF4D8D] to-[#FF6B9D] text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em]">
        {t('deeplink.tryIt')} <ArrowRight size={16} />
      </m.button>

      {/* Comments Section */}
      <m.div variants={itemVariants} className="w-full max-w-md mt-8">
        {/* Comment input */}
        <div className="flex gap-2 mb-4">
          <input value={newComment} onChange={(e) => setNewComment(e.target.value)}
            placeholder={t('deeplink.commentPlaceholder')}
            maxLength={500}
            className="flex-1 bg-white/10 text-white text-sm rounded-xl px-4 py-2 outline-none" />
          <button onClick={handleComment} disabled={submitting || !newComment.trim()}
            className="px-4 py-2 bg-white/10 text-white text-xs rounded-xl hover:bg-white/20">
            {t('deeplink.send')}
          </button>
        </div>
        {/* Comment list */}
        {comments.map((c) => (
          <div key={c.id} className="mb-3 text-white/60 text-sm">
            <p>{c.content}</p>
            <p className="text-white/30 text-xs mt-1">{new Date(c.created_at).toLocaleDateString()}</p>
          </div>
        ))}
      </m.div>
    </m.div>
  );
};

export default SharedCardView;
```

### OG Edge Function

`supabase/functions/serve-og-card/index.ts`:

```typescript
import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

serve(async (req) => {
  const url = new URL(req.url);
  const slug = url.pathname.split('/').pop();

  if (!slug) {
    return new Response('Not found', { status: 404 });
  }

  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
  );

  const { data: card } = await supabase
    .from('shared_cards')
    .select('celeb_name, match_rate, card_image_url, og_image_url')
    .eq('slug', slug)
    .eq('is_public', true)
    .single();

  if (!card) {
    return new Response('Not found', { status: 404 });
  }

  const ogImage = card.og_image_url || card.card_image_url;
  const title = `K-GLOW Card — ${card.celeb_name} ${card.match_rate}% Match`;
  const description = 'AI-powered K-Beauty analysis. Get your personalized K-GLOW Card!';
  const pageUrl = `https://k-mirror.ai/s/${slug}`;

  const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>${title}</title>
  <meta property="og:type" content="website" />
  <meta property="og:url" content="${pageUrl}" />
  <meta property="og:title" content="${title}" />
  <meta property="og:description" content="${description}" />
  <meta property="og:image" content="${ogImage}" />
  <meta property="og:image:width" content="1080" />
  <meta property="og:image:height" content="1920" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="${title}" />
  <meta name="twitter:description" content="${description}" />
  <meta name="twitter:image" content="${ogImage}" />
  <meta http-equiv="refresh" content="0;url=${pageUrl}" />
</head>
<body>
  <p>Redirecting to <a href="${pageUrl}">${title}</a>...</p>
</body>
</html>`;

  return new Response(html, {
    headers: { 'Content-Type': 'text/html; charset=utf-8' },
  });
});
```

### App.tsx 라우트 추가

```typescript
const SharedCardView = lazy(() => import('@/views/SharedCardView'));

// Routes에 추가:
<Route path="/s/:slug" element={<SharedCardView />} />
```

`ROUTE_TITLES`에 추가:
```typescript
'/gallery': 'Gallery',
'/my-shares': 'My Shares',
```

Navbar 제외 목록에 `/s/` 경로 추가 (풀스크린 다크 UI):
```typescript
// 기존 조건에 추가:
location.pathname.startsWith('/s/')
```

### 검증

```bash
npm run typecheck && npm run test:run
```

---

## Task 4: 갤러리 페이지

### 생성/수정 파일

| 파일 | 변경 |
|------|------|
| `src/views/GalleryView.tsx` | CREATE — `/gallery` 공개 갤러리 |
| `src/App.tsx` | MODIFY — `/gallery` 라우트 추가 |
| `src/components/layout/Navbar.tsx` | MODIFY — Gallery 네비게이션 링크 추가 |

### GalleryView.tsx

```typescript
import { useState, useEffect, useCallback, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import * as m from 'framer-motion/m';
import { Heart, Eye } from 'lucide-react';
import { containerVariants, itemVariants } from '@/constants/animations';
import { fetchGalleryCards, type SharedCard } from '@/services/galleryService';

const CELEBS = ['All', 'Jennie', 'Wonyoung', 'Han Sohee', 'Suzy', 'Karina', 'Hanni', 'Hoyeon', 'Taylor Swift'];

const GalleryView = () => {
  const { t } = useTranslation();
  const navigate = useNavigate();
  const [cards, setCards] = useState<SharedCard[]>([]);
  const [loading, setLoading] = useState(true);
  const [celebFilter, setCelebFilter] = useState<string | undefined>();
  const [sort, setSort] = useState<'recent' | 'popular'>('recent');
  const [hasMore, setHasMore] = useState(true);
  const observerRef = useRef<HTMLDivElement>(null);

  const loadCards = useCallback(async (reset = false) => {
    const offset = reset ? 0 : cards.length;
    const data = await fetchGalleryCards({ limit: 20, offset, celebFilter, sort });
    if (reset) setCards(data);
    else setCards((prev) => [...prev, ...data]);
    setHasMore(data.length === 20);
    setLoading(false);
  }, [cards.length, celebFilter, sort]);

  useEffect(() => {
    setLoading(true);
    loadCards(true);
  }, [celebFilter, sort]);

  // Intersection Observer for infinite scroll
  useEffect(() => {
    if (!observerRef.current || !hasMore) return;
    const observer = new IntersectionObserver(
      ([entry]) => { if (entry.isIntersecting) loadCards(); },
      { threshold: 0.1 }
    );
    observer.observe(observerRef.current);
    return () => observer.disconnect();
  }, [hasMore, loadCards]);

  return (
    <m.div initial="hidden" animate="visible" variants={containerVariants}
      className="min-h-screen bg-[#0A0A1A] px-4 py-12">
      <m.h1 variants={itemVariants}
        className="text-2xl sm:text-4xl heading-font text-white text-center mb-8">
        {t('gallery.title')}
      </m.h1>

      {/* Celeb filter pills */}
      <m.div variants={itemVariants} className="flex flex-wrap gap-2 justify-center mb-6">
        {CELEBS.map((c) => (
          <button key={c}
            onClick={() => setCelebFilter(c === 'All' ? undefined : c)}
            className={`px-3 py-1 rounded-full text-xs font-bold transition-all ${
              (c === 'All' && !celebFilter) || celebFilter === c
                ? 'bg-[#FF4D8D] text-white'
                : 'bg-white/10 text-white/50 hover:text-white/80'
            }`}>
            {c}
          </button>
        ))}
      </m.div>

      {/* Sort toggle */}
      <m.div variants={itemVariants} className="flex justify-center gap-4 mb-8">
        {(['recent', 'popular'] as const).map((s) => (
          <button key={s} onClick={() => setSort(s)}
            className={`text-xs uppercase tracking-wider ${sort === s ? 'text-white' : 'text-white/40'}`}>
            {t(`gallery.${s}`)}
          </button>
        ))}
      </m.div>

      {/* Card grid */}
      <div className="grid grid-cols-2 gap-4 max-w-2xl mx-auto">
        {cards.map((card) => (
          <m.div key={card.id} variants={itemVariants}
            onClick={() => navigate(`/s/${card.slug}`)}
            className="cursor-pointer group">
            <img src={card.card_image_url} alt={card.celeb_name}
              className="w-full rounded-2xl group-hover:scale-[1.02] transition-transform"
              loading="lazy" />
            <div className="mt-2 flex items-center justify-between text-white/40 text-xs px-1">
              <span>{card.celeb_name} · {card.match_rate}%</span>
              <div className="flex gap-3">
                <span className="flex items-center gap-1"><Heart size={12} /> {card.likes_count}</span>
                <span className="flex items-center gap-1"><Eye size={12} /> {card.views_count}</span>
              </div>
            </div>
          </m.div>
        ))}
      </div>

      {/* Infinite scroll trigger */}
      <div ref={observerRef} className="h-10" />
      {loading && <div className="text-center text-white/40 text-sm py-4">{t('common.loading')}</div>}
    </m.div>
  );
};

export default GalleryView;
```

### Navbar 링크 추가

기존 네비게이션 링크 목록에 Gallery 추가. Navbar.tsx의 navLinks 배열에:

```typescript
{ to: '/gallery', label: t('nav.gallery') }
```

### 검증

```bash
npm run typecheck && npm run test:run
```

---

## Task 5: 내 공유 통계 페이지

### 생성/수정 파일

| 파일 | 변경 |
|------|------|
| `src/views/MySharesView.tsx` | CREATE — `/my-shares` 내 공유 카드 + 통계 |
| `src/App.tsx` | MODIFY — `/my-shares` 라우트 추가 |

### MySharesView.tsx

```typescript
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import * as m from 'framer-motion/m';
import { Eye, Heart, MessageCircle, ExternalLink } from 'lucide-react';
import { containerVariants, itemVariants } from '@/constants/animations';
import { fetchMyShares, type SharedCard } from '@/services/galleryService';
import { useAuthStore } from '@/store/authStore';

const MySharesView = () => {
  const { t } = useTranslation();
  const navigate = useNavigate();
  const user = useAuthStore((s) => s.user);
  const [cards, setCards] = useState<SharedCard[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) return;
    (async () => {
      const data = await fetchMyShares();
      setCards(data);
      setLoading(false);
    })();
  }, [user]);

  const totalViews = cards.reduce((sum, c) => sum + c.views_count, 0);
  const totalLikes = cards.reduce((sum, c) => sum + c.likes_count, 0);

  if (!user) {
    return /* 로그인 필요 메시지 */;
  }

  return (
    <m.div initial="hidden" animate="visible" variants={containerVariants}>
      <m.h1 variants={itemVariants} className="text-2xl heading-font mb-8">
        {t('myShares.title')}
      </m.h1>

      {/* Summary stats */}
      <m.div variants={itemVariants} className="grid grid-cols-3 gap-4 mb-8">
        <div className="bg-gray-50 rounded-2xl p-4 text-center">
          <p className="text-2xl font-black">{cards.length}</p>
          <p className="text-xs text-gray-500">{t('myShares.totalCards')}</p>
        </div>
        <div className="bg-gray-50 rounded-2xl p-4 text-center">
          <p className="text-2xl font-black">{totalViews}</p>
          <p className="text-xs text-gray-500">{t('myShares.totalViews')}</p>
        </div>
        <div className="bg-gray-50 rounded-2xl p-4 text-center">
          <p className="text-2xl font-black">{totalLikes}</p>
          <p className="text-xs text-gray-500">{t('myShares.totalLikes')}</p>
        </div>
      </m.div>

      {/* Card list */}
      {cards.map((card) => (
        <m.div key={card.id} variants={itemVariants}
          className="flex gap-4 mb-4 p-4 bg-gray-50 rounded-2xl">
          <img src={card.card_image_url} alt={card.celeb_name}
            className="w-20 h-28 object-cover rounded-xl" loading="lazy" />
          <div className="flex-1">
            <p className="font-bold text-sm">{card.celeb_name} · {card.match_rate}%</p>
            <p className="text-xs text-gray-500 mt-1">
              {new Date(card.created_at).toLocaleDateString()}
            </p>
            <div className="flex gap-4 mt-2 text-xs text-gray-400">
              <span className="flex items-center gap-1"><Eye size={12} /> {card.views_count}</span>
              <span className="flex items-center gap-1"><Heart size={12} /> {card.likes_count}</span>
            </div>
          </div>
          <button onClick={() => navigate(`/s/${card.slug}`)}
            className="self-center text-gray-400 hover:text-gray-600">
            <ExternalLink size={16} />
          </button>
        </m.div>
      ))}

      {!loading && cards.length === 0 && (
        <p className="text-center text-gray-400 py-8">{t('myShares.noShares')}</p>
      )}
    </m.div>
  );
};

export default MySharesView;
```

### 검증

```bash
npm run typecheck && npm run test:run
```

---

## Task 6: i18n 키 + GA4 이벤트 + 라우트 정리

### 수정 파일

| 파일 | 변경 |
|------|------|
| `src/i18n/en.json` | MODIFY — gallery, deeplink, social, myShares 키 추가 |
| `src/i18n/ko.json` | MODIFY — 한국어 번역 추가 |
| `src/App.tsx` | MODIFY — ROUTE_TITLES, Navbar 제외 목록 최종 정리 |

### en.json 추가 키

```json
{
  "gallery": {
    "title": "K-GLOW Gallery",
    "recent": "Recent",
    "popular": "Popular",
    "empty": "No cards shared yet. Be the first!"
  },
  "deeplink": {
    "tryIt": "Try It Yourself",
    "commentPlaceholder": "Leave a comment...",
    "send": "Send",
    "notFound": "Card not found",
    "notFoundDesc": "This card may have been removed."
  },
  "share": {
    "publishToGallery": "Publish to Gallery",
    "publishing": "Publishing...",
    "published": "Published!",
    "copyShareLink": "Copy Share Link"
  },
  "myShares": {
    "title": "My Shares",
    "totalCards": "Cards",
    "totalViews": "Views",
    "totalLikes": "Likes",
    "noShares": "You haven't shared any cards yet."
  },
  "nav": {
    "gallery": "Gallery"
  }
}
```

### ko.json 추가 키

```json
{
  "gallery": {
    "title": "K-GLOW 갤러리",
    "recent": "최신순",
    "popular": "인기순",
    "empty": "아직 공유된 카드가 없어요. 첫 번째로 공유해보세요!"
  },
  "deeplink": {
    "tryIt": "나도 해보기",
    "commentPlaceholder": "댓글을 남겨보세요...",
    "send": "전송",
    "notFound": "카드를 찾을 수 없습니다",
    "notFoundDesc": "삭제되었거나 존재하지 않는 카드입니다."
  },
  "share": {
    "publishToGallery": "갤러리에 공유",
    "publishing": "공유 중...",
    "published": "공유 완료!",
    "copyShareLink": "공유 링크 복사"
  },
  "myShares": {
    "title": "내 공유",
    "totalCards": "카드",
    "totalViews": "조회",
    "totalLikes": "좋아요",
    "noShares": "아직 공유한 카드가 없어요."
  },
  "nav": {
    "gallery": "갤러리"
  }
}
```

### GA4 이벤트 요약

이미 각 Task에서 삽입되지만, 정리:
- `card_published` — SharePanel에서 갤러리 공유 시 (Task 2)
- `deeplink_visited` — `/s/:slug` 방문 시 (Task 3)
- `gallery_cta_clicked` — "나도 해보기" 클릭 시 (Task 3)

### 검증

```bash
npm run typecheck && npm run test:run
```

---

## Task 7: 테스트 + 전체 검증

### 생성 파일

| 파일 | 내용 |
|------|------|
| `src/services/galleryService.test.ts` | CREATE — galleryService 핵심 함수 테스트 |
| `src/views/SharedCardView.test.tsx` | CREATE — 딥링크 뷰 렌더링 테스트 |
| `src/views/GalleryView.test.tsx` | CREATE — 갤러리 뷰 렌더링 테스트 |

### galleryService.test.ts 테스트 항목

- `generateSlug`이 8자 문자열 반환
- `publishCard`가 Supabase insert 호출
- `fetchSharedCard`가 slug로 조회
- `toggleLike`가 좋아요 토글 (insert/delete)
- `addComment`가 500자 제한 적용
- `fetchGalleryCards`가 정렬/필터 적용
- `fetchMyShares`가 현재 사용자 카드만 반환

### SharedCardView.test.tsx 테스트 항목

- 로딩 중 스피너 표시
- 카드 데이터 로드 후 이미지 표시
- "나도 해보기" 버튼 클릭 시 /choose-vibe로 이동
- 좋아요 버튼 렌더링

### GalleryView.test.tsx 테스트 항목

- 갤러리 타이틀 렌더링
- 셀럽 필터 버튼 렌더링
- 카드 그리드 렌더링
- 빈 갤러리 상태 처리

### 전체 검증

```bash
npm run typecheck && npm run lint && npm run test:run && npm run build
```

---

## 의존성 순서

```
Task 1 (DB + 서비스) ─── 모든 태스크의 기초
    │
    v
Task 2 (SharePanel 공유 버튼) ─── Task 1 후
Task 3 (딥링크 + OG Edge Function) ─── Task 1 후 (Task 2와 병렬 가능)
    │
    v
Task 4 (갤러리 페이지) ─── Task 1 후 (Task 2,3과 병렬 가능)
Task 5 (내 공유 통계) ─── Task 1 후 (Task 2,3,4와 병렬 가능)
    │
    v
Task 6 (i18n + GA4 + 라우트 정리) ─── Task 2,3,4,5 완료 후
    │
    v
Task 7 (테스트 + 전체 검증) ─── 모두 완료 후
```

## 파일 목록

### 생성 (~7개)

```
supabase/migrations/20260218000000_shared_gallery.sql
supabase/functions/serve-og-card/index.ts
src/services/galleryService.ts
src/views/SharedCardView.tsx
src/views/GalleryView.tsx
src/views/MySharesView.tsx
src/services/galleryService.test.ts
src/views/SharedCardView.test.tsx
src/views/GalleryView.test.tsx
```

### 수정 (~7개)

```
src/components/kglow/SharePanel.tsx
src/services/storageService.ts
src/views/KGlowResultView.tsx
src/App.tsx
src/components/layout/Navbar.tsx
src/i18n/en.json
src/i18n/ko.json
```
